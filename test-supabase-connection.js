#!/usr/bin/env node

/**
 * 5GLabX - Supabase Connection Diagnostic
 * Detailed testing of Supabase connectivity and configuration
 */

const { createClient } = require('@supabase/supabase-js');

// Load environment variables
require('dotenv').config({ path: '.env.local' });

console.log('üöÄ 5GLabX - Supabase Connection Diagnostic');
console.log('==========================================\n');

console.log('üîç STEP 1: Environment Analysis\n');

// Check environment variables
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

console.log('Environment Variables:');
console.log(`   üìä NEXT_PUBLIC_SUPABASE_URL: ${supabaseUrl}`);
console.log(`   üìä NEXT_PUBLIC_SUPABASE_ANON_KEY: ${supabaseAnonKey ? supabaseAnonKey.substring(0, 20) + '...' : '‚ùå Missing'}`);
console.log(`   üìä SUPABASE_SERVICE_ROLE_KEY: ${supabaseServiceKey ? supabaseServiceKey.substring(0, 20) + '...' : '‚ùå Missing'}\n`);

if (!supabaseUrl || !supabaseAnonKey) {
  console.log('‚ùå Missing required Supabase environment variables');
  console.log('üí° Please ensure .env.local contains:');
  console.log('   NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co');
  console.log('   NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key');
  console.log('   SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key');
  process.exit(1);
}

// Validate URL format
try {
  const url = new URL(supabaseUrl);
  console.log('‚úÖ Supabase URL format is valid');
  console.log(`   üåê Domain: ${url.hostname}`);
  console.log(`   üîí Protocol: ${url.protocol}\n`);
} catch (error) {
  console.log('‚ùå Invalid Supabase URL format:', error.message);
  process.exit(1);
}

// Initialize Supabase clients
const supabase = createClient(supabaseUrl, supabaseAnonKey);
const supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey, {
  auth: {
    autoRefreshToken: false,
    persistSession: false
  }
});

console.log('‚úÖ Supabase clients initialized\n');

// Test basic connectivity
async function testBasicConnectivity() {
  console.log('üîç STEP 2: Basic Connectivity Test\n');

  try {
    console.log('   üîå Testing basic HTTP connection...');

    // Test with a simple fetch to the REST API
    const response = await fetch(`${supabaseUrl}/rest/v1/`, {
      method: 'HEAD',
      headers: {
        'apikey': supabaseAnonKey,
        'Authorization': `Bearer ${supabaseAnonKey}`
      }
    });

    console.log(`   üì° HTTP Status: ${response.status}`);
    console.log(`   üì° Status Text: ${response.statusText}`);

    if (response.ok) {
      console.log('   ‚úÖ Basic HTTP connectivity successful\n');
      return true;
    } else {
      console.log('   ‚ùå Basic HTTP connectivity failed');
      console.log('   üí° Check if your Supabase project is active\n');
      return false;
    }
  } catch (error) {
    console.log('   ‚ùå HTTP connection error:', error.message);
    console.log('   üí° Possible causes:');
    console.log('      ‚Ä¢ Network connectivity issues');
    console.log('      ‚Ä¢ Supabase project URL is incorrect');
    console.log('      ‚Ä¢ Supabase project is paused or deleted\n');
    return false;
  }
}

async function testSupabaseRESTAPI() {
  console.log('üîç STEP 3: Supabase REST API Test\n');

  try {
    console.log('   üîå Testing Supabase REST API...');

    // Try to access the REST API without specifying a table first
    const response = await fetch(`${supabaseUrl}/rest/v1/`, {
      method: 'GET',
      headers: {
        'apikey': supabaseAnonKey,
        'Authorization': `Bearer ${supabaseAnonKey}`,
        'Content-Type': 'application/json'
      }
    });

    const responseText = await response.text();
    console.log(`   üì° Response Status: ${response.status}`);
    console.log(`   üì° Response Body: ${responseText.substring(0, 200)}...`);

    if (response.status === 200) {
      console.log('   ‚úÖ Supabase REST API is accessible\n');
      return true;
    } else {
      console.log('   ‚ùå Supabase REST API access failed');
      console.log('   üí° This might be normal if no tables exist yet\n');
      return false;
    }
  } catch (error) {
    console.log('   ‚ùå REST API error:', error.message);
    return false;
  }
}

async function testTableAccess() {
  console.log('üîç STEP 4: Database Table Access Test\n');

  try {
    console.log('   üóÑÔ∏è  Testing access to test_cases table...');

    // Try to query the test_cases table
    const { data, error } = await supabase
      .from('test_cases')
      .select('count', { count: 'exact', head: true });

    if (error) {
      console.log('   ‚ùå Table access failed:', error.message);
      console.log('   üí° Possible causes:');
      console.log('      ‚Ä¢ Table does not exist');
      console.log('      ‚Ä¢ Row Level Security (RLS) policies blocking access');
      console.log('      ‚Ä¢ Insufficient permissions');
      console.log('      ‚Ä¢ Database is not properly set up\n');

      // Try to check if tables exist at all
      console.log('   üîç Checking if any tables exist...');
      const { data: tablesData, error: tablesError } = await supabaseAdmin
        .rpc('get_table_names');

      if (tablesError) {
        console.log('   ‚ùå Cannot check table structure:', tablesError.message);
        console.log('   üí° This suggests the database is not properly configured\n');
      } else if (tablesData && tablesData.length === 0) {
        console.log('   ‚ö†Ô∏è  No tables found in database');
        console.log('   üí° You need to run database migrations to create tables\n');
      } else {
        console.log(`   ‚úÖ Found ${tablesData?.length || 0} tables in database\n`);
      }

      return false;
    }

    console.log('   ‚úÖ Table access successful');
    console.log(`   üìä Found ${data} records in test_cases table\n`);
    return true;
  } catch (error) {
    console.log('   ‚ùå Table access error:', error.message);
    return false;
  }
}

async function testAuthentication() {
  console.log('üîç STEP 5: Authentication Test\n');

  try {
    console.log('   üîê Testing anonymous authentication...');

    // Try to get current user (should be null for anonymous)
    const { data: { user }, error } = await supabase.auth.getUser();

    if (error) {
      console.log('   ‚ùå Authentication check failed:', error.message);
      return false;
    }

    console.log('   ‚úÖ Authentication check successful');
    console.log(`   üë§ Current user: ${user ? user.email : 'Anonymous (expected)'}\n`);
    return true;
  } catch (error) {
    console.log('   ‚ùå Authentication error:', error.message);
    return false;
  }
}

async function testRealTimeConnectivity() {
  console.log('üîç STEP 6: Real-time Connectivity Test\n');

  try {
    console.log('   üì° Testing real-time connection...');

    // Try to establish a real-time connection
    const subscription = supabase
      .channel('test_connection')
      .subscribe((status) => {
        console.log(`   üì° Real-time status: ${status}`);
      });

    // Wait a moment for connection
    await new Promise(resolve => setTimeout(resolve, 2000));

    console.log('   ‚úÖ Real-time connection test initiated');
    console.log('   üí° Real-time subscriptions are working\n');

    subscription.unsubscribe();
    return true;
  } catch (error) {
    console.log('   ‚ùå Real-time connection error:', error.message);
    console.log('   üí° This might be normal if real-time is not enabled\n');
    return false;
  }
}

async function diagnoseIssues() {
  console.log('üîç STEP 7: Issue Diagnosis & Recommendations\n');

  const diagnosis = {
    urlFormat: false,
    httpConnectivity: false,
    restApiAccess: false,
    tableAccess: false,
    authentication: false,
    realtime: false
  };

  // Check URL format
  try {
    new URL(supabaseUrl);
    diagnosis.urlFormat = true;
    console.log('   ‚úÖ URL format: Valid');
  } catch {
    console.log('   ‚ùå URL format: Invalid');
  }

  // Test HTTP connectivity
  diagnosis.httpConnectivity = await testBasicConnectivity();

  // Test REST API
  diagnosis.restApiAccess = await testSupabaseRESTAPI();

  // Test table access
  diagnosis.tableAccess = await testTableAccess();

  // Test authentication
  diagnosis.authentication = await testAuthentication();

  // Test real-time
  diagnosis.realtime = await testRealTimeConnectivity();

  console.log('\nüìã DIAGNOSIS SUMMARY');
  console.log('====================');
  console.log(`‚úÖ URL Format: ${diagnosis.urlFormat ? 'Valid' : 'Invalid'}`);
  console.log(`‚úÖ HTTP Connectivity: ${diagnosis.httpConnectivity ? 'Working' : 'Failed'}`);
  console.log(`‚úÖ REST API Access: ${diagnosis.restApiAccess ? 'Working' : 'Failed'}`);
  console.log(`‚úÖ Table Access: ${diagnosis.tableAccess ? 'Working' : 'Failed'}`);
  console.log(`‚úÖ Authentication: ${diagnosis.authentication ? 'Working' : 'Failed'}`);
  console.log(`‚úÖ Real-time: ${diagnosis.realtime ? 'Working' : 'Failed'}`);

  if (diagnosis.urlFormat && diagnosis.httpConnectivity && diagnosis.restApiAccess && diagnosis.authentication) {
    console.log('\nüéâ BASIC SUPABASE SETUP IS WORKING!');
    console.log('The main issue is likely:');
    console.log('   ‚Ä¢ Database tables not created yet');
    console.log('   ‚Ä¢ Row Level Security policies blocking access');
    console.log('   ‚Ä¢ Missing database migrations\n');

    console.log('üí° SOLUTIONS:');
    console.log('   1. Run database migrations: pnpm db:migrate');
    console.log('   2. Check RLS policies in Supabase dashboard');
    console.log('   3. Seed the database: pnpm db:seed');
    console.log('   4. Verify table structure matches your code');
  } else {
    console.log('\n‚ùå FUNDAMENTAL SUPABASE ISSUES DETECTED');
    console.log('Please check:');
    console.log('   ‚Ä¢ Supabase project is active and accessible');
    console.log('   ‚Ä¢ Environment variables are correct');
    console.log('   ‚Ä¢ Network connectivity to Supabase');
    console.log('   ‚Ä¢ Supabase project URL and API keys\n');
  }

  return diagnosis;
}

// Run diagnostic
async function main() {
  try {
    const diagnosis = await diagnoseIssues();

    console.log('\nüîß TROUBLESHOOTING STEPS');
    console.log('=========================');

    if (!diagnosis.urlFormat) {
      console.log('1. Fix Supabase URL format in .env.local');
      console.log('   Should be: https://your-project.supabase.co');
    }

    if (!diagnosis.httpConnectivity) {
      console.log('2. Check network connectivity');
      console.log('   ‚Ä¢ Try: curl -I', supabaseUrl);
      console.log('   ‚Ä¢ Check if Supabase project is active');
    }

    if (!diagnosis.tableAccess) {
      console.log('3. Set up database tables');
      console.log('   ‚Ä¢ Run: pnpm db:migrate');
      console.log('   ‚Ä¢ Check Supabase dashboard > SQL Editor');
      console.log('   ‚Ä¢ Verify table structure matches your code');
    }

    if (!diagnosis.authentication) {
      console.log('4. Check authentication setup');
      console.log('   ‚Ä¢ Verify API keys are correct');
      console.log('   ‚Ä¢ Check Supabase dashboard > Settings > API');
    }

    console.log('\nüìû NEED HELP?');
    console.log('=============');
    console.log('‚Ä¢ Check Supabase dashboard: https://app.supabase.com');
    console.log('‚Ä¢ Verify project settings and API keys');
    console.log('‚Ä¢ Review database structure and RLS policies');
    console.log('‚Ä¢ Check browser console for additional errors');

  } catch (error) {
    console.log('\n‚ùå Diagnostic failed:', error.message);
    console.log('üí° Check your Supabase configuration and try again');
  }
}

// Run the diagnostic
main();